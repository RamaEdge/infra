---
# Ingress 1 — API paths (NGINX basic auth, for pip/twine)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: devpi-api
  namespace: devpi
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: devpi-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "devpi"
    nginx.ingress.kubernetes.io/proxy-body-size: "500m"
spec:
  ingressClassName: nginx
  tls:
    - secretName: devpi-tls
      hosts:
        - pypi.theedgeworks.ai
  rules:
    - host: pypi.theedgeworks.ai
      http:
        paths:
          - path: /root/
            pathType: Prefix
            backend:
              service:
                name: devpi
                port:
                  number: 3141
          - path: /upload/
            pathType: Prefix
            backend:
              service:
                name: devpi
                port:
                  number: 3141
          - path: /+api
            pathType: ImplementationSpecific
            backend:
              service:
                name: devpi
                port:
                  number: 3141
          - path: /+login
            pathType: ImplementationSpecific
            backend:
              service:
                name: devpi
                port:
                  number: 3141
---
# Ingress 2 — Web UI (oauth2-proxy, for browsers)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: devpi-web
  namespace: devpi
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/auth-url: "http://devpi-devpi-oauth2-proxy.devpi.svc.cluster.local:80/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "https://pypi.theedgeworks.ai/oauth2/start?rd=$scheme://$host$request_uri"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email"
spec:
  ingressClassName: nginx
  tls:
    - secretName: devpi-tls
      hosts:
        - pypi.theedgeworks.ai
  rules:
    - host: pypi.theedgeworks.ai
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: devpi
                port:
                  number: 3141
---
# Ingress 3 — oauth2-proxy callback (no auth annotations)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: devpi-oauth2
  namespace: devpi
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  tls:
    - secretName: devpi-tls
      hosts:
        - pypi.theedgeworks.ai
  rules:
    - host: pypi.theedgeworks.ai
      http:
        paths:
          - path: /oauth2
            pathType: Prefix
            backend:
              service:
                name: devpi-devpi-oauth2-proxy
                port:
                  number: 80
